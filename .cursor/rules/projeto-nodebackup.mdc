---
description: 
globs: 
alwaysApply: true
---
# Node-Backup: SQL Server - Vis√£o Geral do Projeto

## Descri√ß√£o do Projeto
O Node-Backup √© uma aplica√ß√£o Windows para automatiza√ß√£o de backups de bancos SQL Server com interface web moderna e segura. A aplica√ß√£o:
- Gera backups `.bak` de m√∫ltiplos bancos SQL Server
- Comprime em arquivos `.7z` com alta compress√£o
- Envia para servidores FTP automaticamente
- Funciona como servi√ßo do Windows
- Interface web responsiva com autentica√ß√£o criptografada
- **Sistema de hist√≥rico completo** com SQLite
- **Pol√≠tica de reten√ß√£o** configur√°vel para limpeza autom√°tica
- **Logs em tempo real** via WebSocket para monitoramento ao vivo
- **Sistema de notifica√ß√µes multi-canal** (E-mail e WhatsApp)
- **Auto-update transparente** via GitHub
- **Arquitetura modular** frontend e backend

## Arquitetura Modular Atual

### Ponto de Entrada
- [src/app.js](mdc:src/app.js) - Entry point principal da aplica√ß√£o
- [src/server.js](mdc:src/server.js) - Servidor Express com WebSocket
- [src/config.js](mdc:src/config.js) - Sistema de configura√ß√£o criptografada

### Servi√ßos Core
- [src/services/database.js](mdc:src/services/database.js) - Backup e listagem de bancos SQL Server
- [src/services/ftp.js](mdc:src/services/ftp.js) - Upload para servidores FTP
- [src/services/history.js](mdc:src/services/history.js) - Gerenciamento hist√≥rico SQLite
- [src/services/scheduler.js](mdc:src/services/scheduler.js) - Agendamento de backups
- [src/services/windowsService.js](mdc:src/services/windowsService.js) - Instala√ß√£o como servi√ßo Windows
- [src/services/updater.js](mdc:src/services/updater.js) - Sistema de auto-update com GitHub
- [src/services/notification.js](mdc:src/services/notification.js) - Sistema de notifica√ß√µes SMTP com templates HTML
- [src/services/whatsapp.js](mdc:src/services/whatsapp.js) - Sistema de notifica√ß√µes WhatsApp via WuzAPI

### Utilit√°rios
- [src/utils/logger.js](mdc:src/utils/logger.js) - Sistema de logging com rota√ß√£o di√°ria e WebSocket streaming
- [src/utils/encryption.js](mdc:src/utils/encryption.js) - Criptografia para configura√ß√µes
- [src/utils/errorHandler.js](mdc:src/utils/errorHandler.js) - Tratamento amig√°vel de erros
- [src/utils/sessionStore.js](mdc:src/utils/sessionStore.js) - Armazenamento customizado de sess√µes em JSON

### API Modular (src/api/)
- **Middleware**: [src/api/middleware/auth.js](mdc:src/api/middleware/auth.js) - Autentica√ß√£o centralizada
- **Rotas por Funcionalidade**:
  - [src/api/routes/auth.js](mdc:src/api/routes/auth.js) - Login, logout, mudan√ßa senha
  - [src/api/routes/browse.js](mdc:src/api/routes/browse.js) - Navega√ß√£o arquivos/pastas
  - [src/api/routes/config.js](mdc:src/api/routes/config.js) - Configura√ß√µes aplica√ß√£o
  - [src/api/routes/database.js](mdc:src/api/routes/database.js) - Opera√ß√µes SQL Server
  - [src/api/routes/history.js](mdc:src/api/routes/history.js) - Hist√≥rico e estat√≠sticas
  - [src/api/routes/storage.js](mdc:src/api/routes/storage.js) - FTP e limpeza
  - [src/api/routes/updater.js](mdc:src/api/routes/updater.js) - Verifica√ß√£o e instala√ß√£o de atualiza√ß√µes
  - [src/api/routes/notifications.js](mdc:src/api/routes/notifications.js) - Configura√ß√£o SMTP e envio de e-mails
  - [src/api/routes/whatsapp.js](mdc:src/api/routes/whatsapp.js) - Configura√ß√£o WuzAPI e envio de mensagens

### Interface Web Modular (public/)
- **CSS Modular (25KB total)**:
  - [public/css/base.css](mdc:public/css/base.css) - Vari√°veis, reset, temas (4KB)
  - [public/css/components.css](mdc:public/css/components.css) - Componentes UI (13KB)
  - [public/css/layout.css](mdc:public/css/layout.css) - Layout, header, sidebar (3KB)
  - [public/css/login.css](mdc:public/css/login.css) - Login/setup (2KB)
  - [public/css/responsive.css](mdc:public/css/responsive.css) - Media queries (3KB)

- **JavaScript Modular (74KB total)**:
  - [public/js/ui.js](mdc:public/js/ui.js) - Componentes UI, temas, toasts (8KB)
  - [public/js/config.js](mdc:public/js/config.js) - Configura√ß√µes (8KB)
  - [public/js/database.js](mdc:public/js/database.js) - Sele√ß√£o bancos (8KB)
  - [public/js/history.js](mdc:public/js/history.js) - Painel hist√≥rico (14KB)
  - [public/js/storage.js](mdc:public/js/storage.js) - FTP, limpeza (9KB)
  - [public/js/schedule.js](mdc:public/js/schedule.js) - Agendamento (3KB)
  - [public/js/auth.js](mdc:public/js/auth.js) - Autentica√ß√£o (1KB)
  - [public/js/api.js](mdc:public/js/api.js) - Requisi√ß√µes API (1KB)
  - [public/js/logs.js](mdc:public/js/logs.js) - Logs em tempo real (10KB)
  - [public/js/updater.js](mdc:public/js/updater.js) - Auto-update interface (3KB)
  - [public/js/notifications.js](mdc:public/js/notifications.js) - Notifica√ß√µes SMTP interface (7KB)
  - [public/js/whatsapp.js](mdc:public/js/whatsapp.js) - Notifica√ß√µes WhatsApp interface (8KB)

- **HTML Pages**:
  - [public/index.html](mdc:public/index.html) - Dashboard principal
  - [public/login.html](mdc:public/login.html) - Tela de login
  - [public/setup.html](mdc:public/setup.html) - Configura√ß√£o inicial
  - [public/script.js](mdc:public/script.js) - Entry point JS (importa m√≥dulos)

## Stack Tecnol√≥gica
- **Runtime**: Node.js 12+ (compatibilidade obrigat√≥ria)
- **Framework Web**: Express.js 4.19.2
- **WebSocket**: Socket.IO 4.x (compat√≠vel Node 12)
- **Banco Hist√≥rico**: SQLite 3 (via sql.js 1.8.0 - Node 12 compat√≠vel)
- **Banco Principal**: SQL Server (via mssql 6.3.2 e sqlcmd)
- **Autentica√ß√£o**: bcryptjs + express-session com CustomSessionStore
- **Agendamento**: node-schedule 2.1.1
- **FTP**: basic-ftp 5.0.5
- **Logging**: winston 3.3.3 com winston-daily-rotate-file + WebSocket streaming
- **Notifica√ß√µes**: nodemailer 6.9.13 para envio de e-mails SMTP
- **Criptografia**: crypto-js 4.2.0
- **Compress√£o**: 7-Zip (7za.exe embarcado)
- **Servi√ßo Windows**: NSSM (nssm.exe embarcado)
- **Build**: pkg 5.8.1 para execut√°vel √∫nico
- **Frontend**: JavaScript ES6 Modules + CSS Variables

## Funcionalidades Implementadas (v1.0.0)

### üîê Autentica√ß√£o e Seguran√ßa
- Setup inicial obrigat√≥rio via web
- Sistema de login com hash bcrypt
- Middleware de autentica√ß√£o centralizado
- Configura√ß√µes criptografadas (config.enc)
- Preven√ß√£o FOUC (Flash of Unstyled Content)
- **Sess√µes persistentes com CustomSessionStore** (JSON)

### üíæ Backup e Armazenamento
- Backup autom√°tico SQL Server (.bak)
- Compress√£o 7-Zip alta performance
- Upload FTP automatizado
- Pol√≠tica de reten√ß√£o configur√°vel
- Modo Cl√°ssico vs Reten√ß√£o (timestamp)
- Limpeza autom√°tica local e FTP
- **Preven√ß√£o de execu√ß√µes simult√¢neas**

### ‚è∞ Agendamento e Monitoramento  
- Agendamento flex√≠vel de backups
- Hist√≥rico completo com SQLite
- Estat√≠sticas detalhadas (total, sucessos, falhas, dura√ß√£o)
- Interface de hist√≥rico responsiva
- Filtros por status e pagina√ß√£o
- **Logs em tempo real via WebSocket**

### üé® Interface Moderna
- Design responsivo mobile-first
- Sistema dual de temas (claro/escuro)
- Sidebar colaps√°vel para mobile
- Componentes modularizados
- Toast notifications inteligentes
- Loading states em todas opera√ß√µes
- **Aba "Logs ao Vivo" com controles interativos**
- **Indicador de vers√£o e atualiza√ß√µes dispon√≠veis**

### üîÑ Auto-Update
- **Sistema de atualiza√ß√£o autom√°tica** completo e transparente
- **Verifica√ß√£o peri√≥dica** de novas vers√µes (a cada 6 horas)
- **Download inteligente** com prioriza√ß√£o de instalador
- **Instala√ß√£o silenciosa** sem interrup√ß√£o do servi√ßo
- **Gerenciamento autom√°tico** do servi√ßo Windows
- **Rollback autom√°tico** em caso de falha
- **Interface visual** para acompanhar atualiza√ß√µes

### üìß Sistema de Notifica√ß√µes Multi-canal
#### E-mail SMTP
- **Configura√ß√£o SMTP completa** via interface web com teste de conex√£o
- **Templates HTML responsivos** com design moderno e tema claro/escuro
- **Notifica√ß√µes granulares** - controle de quando enviar (sucesso/falha/ambos)
- **M√∫ltiplos destinat√°rios** com sistema de gerenciamento e valida√ß√£o
- **Diagn√≥stico SMTP avan√ßado** com sugest√µes inteligentes para problemas
- **Templates especializados** para sucesso, falha e teste
- **Integra√ß√£o autom√°tica** com scheduler para notifica√ß√µes ap√≥s backups
- **Logo personalizado** nos e-mails via imagem embarcada

#### WhatsApp WuzAPI
- **Integra√ß√£o WuzAPI completa** via interface web com configura√ß√£o de URL e token
- **Teste de conex√£o** com diagn√≥stico detalhado e sugest√µes inteligentes
- **Gerenciamento de n√∫meros** para m√∫ltiplos destinat√°rios com valida√ß√£o
- **Notifica√ß√µes configur√°veis** - controle granular (sucesso/falha/ambos)
- **Templates de mensagem** personalizados para diferentes status de backup
- **Integra√ß√£o autom√°tica** com scheduler para envio ap√≥s cada backup
- **Compatibilidade Node.js 12** usando m√≥dulos nativos http/https
- **APIs REST completas** para configura√ß√£o, teste e envio

### üîß Infraestrutura
- Instala√ß√£o como servi√ßo Windows (NSSM)
- Sistema de logs rotacionados
- Build automatizado (pkg)
- Execut√°vel autocontido
- **WebSocket server integrado para streaming de logs**
- **Instalador NSIS otimizado para modo silencioso**

## Sistema de Build
- [scripts/build.js](mdc:scripts/build.js) - Embarca assets e gera execut√°vel
- [package.json](mdc:package.json) - Configura√ß√£o npm e scripts
- Target: Windows x64 com Node 12 (pkg node12-win-x64)
- Assets embarcados: 7za.exe, nssm.exe, pasta public/ completa

## Configura√ß√£o e Seguran√ßa
- Configura√ß√µes salvas em [config.enc](mdc:config.enc) criptografadas
- Primeira execu√ß√£o ativa setup inicial obrigat√≥rio
- Interface protegida por sess√µes autenticadas
- Logs rotacionados em [logs/](mdc:logs) com reten√ß√£o configur√°vel
- Hist√≥rico persistido em SQLite local
- **Sess√µes armazenadas em JSON via CustomSessionStore**

## Versionamento Atual
- **Vers√£o Atual**: v1.0.0 (Release Est√°vel)
- **Release Anterior**: v0.5.0 (Notifica√ß√µes WhatsApp via WuzAPI)
- **Pr√≥xima Planejada**: v1.1.0 (Backup Multi-Fonte)

## M√©tricas de Qualidade
- **Execut√°vel**: ~85MB (autocontido)
- **Frontend**: 99KB total (74KB JS + 25KB CSS)
- **Compatibilidade**: Windows 7+ x64
- **SQL Server**: 2008 R2+ at√© 2022
- **Performance**: < 200MB RAM, < 5s startup
- **Arquitetura**: Modular, manuten√≠vel, escal√°vel
- **Auto-Update**: Verifica√ß√£o a cada 6h, instala√ß√£o silenciosa
- **Notifica√ß√µes**: E-mail SMTP + WhatsApp WuzAPI com templates responsivos

## Pr√≥ximos Desenvolvimentos (Roadmap)
1. **v1.1.0**: Backup Multi-Fonte (Arquivos + MySQL/PostgreSQL)
2. **v1.2.0**: Cloud Integration (AWS S3, Google Drive)
3. **v2.0.0**: Interface de Restaura√ß√£o e funcionalidades premium

