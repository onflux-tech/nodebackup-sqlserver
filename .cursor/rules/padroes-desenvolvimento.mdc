---
description: 
globs: 
alwaysApply: true
---
# PadrÃµes de Desenvolvimento e Compatibilidade

## ğŸ”„ Compatibilidade Node.js 12

### ObrigatÃ³rio para Todo Desenvolvimento
- **Target MÃ­nimo**: Node.js 12.x LTS
- **Build Target**: pkg node12-win-x64 (conforme [scripts/build.js](mdc:scripts/build.js))
- **Evitar**: Features do Node.js 14+ (optional chaining, nullish coalescing)
- **Usar**: Sintaxe ES2018 e anterior

### DependÃªncias CompatÃ­veis (package.json)
- Express 4.19.2 (compatÃ­vel Node 12)
- mssql 6.3.2 (Ãºltima versÃ£o compatÃ­vel)
- winston 3.3.3 (evitar versÃµes 3.8+)
- pkg 5.8.1 (suporte a Node 12)

## ğŸ“ PadrÃµes de Estrutura

### OrganizaÃ§Ã£o de Arquivos
```
src/
â”œâ”€â”€ app.js              # Entry point principal
â”œâ”€â”€ server.js           # ConfiguraÃ§Ã£o Express
â”œâ”€â”€ config.js           # Gerenciamento configuraÃ§Ã£o
â”œâ”€â”€ api/
â”‚   â””â”€â”€ routes.js       # Todas as rotas REST
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ database.js     # OperaÃ§Ãµes SQL Server
â”‚   â”œâ”€â”€ ftp.js         # OperaÃ§Ãµes FTP
â”‚   â”œâ”€â”€ scheduler.js   # Agendamento
â”‚   â””â”€â”€ windowsService.js # ServiÃ§o Windows
â””â”€â”€ utils/
    â”œâ”€â”€ logger.js       # Sistema logging
    â”œâ”€â”€ encryption.js   # Criptografia
    â””â”€â”€ errorHandler.js # Tratamento erros
```

### Interface Web (public/)
- **index.html** - Dashboard principal
- **script.js** - JavaScript principal (manter < 25KB)
- **styles.css** - CSS principal (manter < 15KB)
- **login.html/js** - Sistema autenticaÃ§Ã£o
- **setup.html/js** - ConfiguraÃ§Ã£o inicial

## ğŸ› ï¸ PadrÃµes de CÃ³digo

### MÃ³dulos e Imports
```javascript
// âœ… Usar CommonJS (Node 12 compatÃ­vel)
const express = require('express');
const { getConfig } = require('./config');

// âŒ Evitar ES Modules
import express from 'express';
```

### Tratamento de Erros
- Sempre usar [src/utils/logger.js](mdc:src/utils/logger.js)
- Aplicar [src/utils/errorHandler.js](mdc:src/utils/errorHandler.js) para erros de usuÃ¡rio
- Logs estruturados com nÃ­veis apropriados

### Async/Await (Node 12+)
```javascript
// âœ… Async/await suportado
async function performBackup() {
  try {
    const result = await backupDatabase();
    logger.info('Backup concluÃ­do');
    return result;
  } catch (error) {
    logger.error('Falha no backup', error);
    throw error;
  }
}
```

### ConfiguraÃ§Ã£o Segura
- Todas as configuraÃ§Ãµes via [src/config.js](mdc:src/config.js)
- Arquivo config.enc criptografado obrigatÃ³rio
- Nunca hardcode credenciais

## ğŸ”’ PadrÃµes de SeguranÃ§a

### AutenticaÃ§Ã£o (src/api/routes.js)
- bcryptjs para hash de senhas
- express-session para sessÃµes
- ValidaÃ§Ã£o obrigatÃ³ria em todas as rotas protegidas

### Criptografia
- Usar [src/utils/encryption.js](mdc:src/utils/encryption.js)
- crypto-js para criptografia simÃ©trica
- Nunca salvar dados sensÃ­veis em plain text

## ğŸ“ Logging PadrÃ£o

### NÃ­veis de Log (winston)
- **error**: Falhas crÃ­ticas, exceÃ§Ãµes
- **warn**: SituaÃ§Ãµes inesperadas, nÃ£o crÃ­ticas
- **info**: OperaÃ§Ãµes principais, status
- **debug**: InformaÃ§Ãµes detalhadas (desenvolvimento)

### Formato PadrÃ£o
```javascript
logger.info('Iniciando backup de bancos: ' + databases.join(', '));
logger.error('Falha ao conectar FTP', { host: config.ftp.host, error: err.message });
```

## ğŸš€ Build e Deployment

### Build Process ([scripts/build.js](mdc:scripts/build.js))
1. Embarca assets (7za.exe, nssm.exe, public/)
2. Gera embedded-assets.js temporÃ¡rio
3. Executa pkg com target node12-win-x64
4. Limpa arquivos temporÃ¡rios

### Assets Embarcados
- 7za.exe para compressÃ£o
- nssm.exe para serviÃ§o Windows
- Todos os arquivos public/ para interface web

### ExecutÃ¡vel Final
- NodeBackup.exe Ãºnico (Â±57MB)
- Autocontido, sem dependÃªncias externas
- CompatÃ­vel Windows 7+

## ğŸ”„ Testes e ValidaÃ§Ã£o

### Compatibilidade ObrigatÃ³ria
- Testar em Node.js 12.x antes de commit
- Validar build com pkg node12-win-x64
- Verificar funcionamento como serviÃ§o Windows

### ValidaÃ§Ãµes de CÃ³digo
- NÃ£o usar features Node 14+
- Evitar dependÃªncias que quebrem Node 12
- Manter compatibilidade com sqlcmd legado

