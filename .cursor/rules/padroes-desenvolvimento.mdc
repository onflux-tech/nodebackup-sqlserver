---
description: 
globs: 
alwaysApply: true
---
# PadrÃµes de Desenvolvimento e Compatibilidade

## ğŸ”„ Compatibilidade Node.js 12

### ObrigatÃ³rio para Todo Desenvolvimento
- **Target MÃ­nimo**: Node.js 12.x LTS
- **Build Target**: pkg node12-win-x64 (conforme [scripts/build.js](mdc:scripts/build.js))
- **Evitar**: Features do Node.js 14+ (optional chaining, nullish coalescing)
- **Usar**: Sintaxe ES2018 e anterior

### DependÃªncias CompatÃ­veis (package.json)
- Express 4.19.2 (compatÃ­vel Node 12)
- mssql 6.3.2 (Ãºltima versÃ£o compatÃ­vel)
- winston 3.3.3 (evitar versÃµes 3.8+)
- pkg 5.8.1 (suporte a Node 12)

## ğŸ“ PadrÃµes de Estrutura Modular

### OrganizaÃ§Ã£o Backend (src/)
```
src/
â”œâ”€â”€ app.js              # Entry point principal
â”œâ”€â”€ server.js           # ConfiguraÃ§Ã£o Express
â”œâ”€â”€ config.js           # Gerenciamento configuraÃ§Ã£o
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.js     # Middleware autenticaÃ§Ã£o
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ auth.js     # Rotas autenticaÃ§Ã£o
â”‚       â”œâ”€â”€ browse.js   # Rotas navegaÃ§Ã£o arquivos
â”‚       â”œâ”€â”€ config.js   # Rotas configuraÃ§Ã£o
â”‚       â”œâ”€â”€ database.js # Rotas banco de dados
â”‚       â”œâ”€â”€ history.js  # Rotas histÃ³rico
â”‚       â””â”€â”€ storage.js  # Rotas armazenamento
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ database.js     # OperaÃ§Ãµes SQL Server
â”‚   â”œâ”€â”€ ftp.js         # OperaÃ§Ãµes FTP
â”‚   â”œâ”€â”€ history.js     # ServiÃ§o histÃ³rico SQLite
â”‚   â”œâ”€â”€ scheduler.js   # Agendamento
â”‚   â””â”€â”€ windowsService.js # ServiÃ§o Windows
â””â”€â”€ utils/
    â”œâ”€â”€ logger.js       # Sistema logging
    â”œâ”€â”€ encryption.js   # Criptografia
    â””â”€â”€ errorHandler.js # Tratamento erros
```

### OrganizaÃ§Ã£o Frontend Modular (public/)
```
public/
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ base.css        # VariÃ¡veis CSS, reset, temas
â”‚   â”œâ”€â”€ components.css  # Componentes UI (botÃµes, forms, cards)
â”‚   â”œâ”€â”€ layout.css      # Layout principal, header, sidebar
â”‚   â”œâ”€â”€ login.css       # Estilos pÃ¡gina login/setup
â”‚   â””â”€â”€ responsive.css  # Media queries responsivas
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ api.js         # FunÃ§Ãµes requisiÃ§Ãµes API
â”‚   â”œâ”€â”€ auth.js        # LÃ³gica autenticaÃ§Ã£o/logout
â”‚   â”œâ”€â”€ config.js      # Gerenciamento configuraÃ§Ãµes
â”‚   â”œâ”€â”€ database.js    # SeleÃ§Ã£o e listagem bancos
â”‚   â”œâ”€â”€ history.js     # Painel histÃ³rico backups
â”‚   â”œâ”€â”€ schedule.js    # Agendamento backups
â”‚   â”œâ”€â”€ storage.js     # ConfiguraÃ§Ã£o FTP e limpeza
â”‚   â””â”€â”€ ui.js          # Componentes UI (tema, tabs, toasts)
â”œâ”€â”€ index.html         # Dashboard principal
â”œâ”€â”€ login.html         # PÃ¡gina login
â”œâ”€â”€ setup.html         # ConfiguraÃ§Ã£o inicial
â”œâ”€â”€ script.js          # Entry point JS (importa mÃ³dulos)
â”œâ”€â”€ login.js           # Script pÃ¡gina login
â””â”€â”€ setup.js           # Script configuraÃ§Ã£o inicial
```

## ğŸ› ï¸ PadrÃµes de CÃ³digo Modular

### MÃ³dulos JavaScript (ES6 Modules)
```javascript
// âœ… Exportar funÃ§Ãµes especÃ­ficas
export function setupThemeToggle() { /* ... */ }
export function showToast(message, type) { /* ... */ }

// âœ… Importar mÃ³dulos no entry point
import { setupThemeToggle, setupTabs } from './js/ui.js';
import { setupConfigForm, loadConfig } from './js/config.js';
import { setupDatabase } from './js/database.js';
```

### OrganizaÃ§Ã£o de Rotas API
```javascript
// âœ… Rotas separadas por funcionalidade
const express = require('express');
const router = express.Router();
const { requireAuth } = require('../middleware/auth');

// Aplicar middleware quando necessÃ¡rio
router.get('/config', requireAuth, getConfig);
router.post('/config', requireAuth, saveConfig);

module.exports = router;
```

### CSS Modular com VariÃ¡veis
```css
/* âœ… Usar variÃ¡veis CSS definidas em base.css */
.card {
  background-color: var(--bg-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
}

/* âœ… Temas automÃ¡ticos */
[data-theme="dark"] {
  --bg-primary: #0f172a;
  --text-primary: #f8fafc;
}
```

### Tratamento de Erros
- Sempre usar [src/utils/logger.js](mdc:src/utils/logger.js)
- Aplicar [src/utils/errorHandler.js](mdc:src/utils/errorHandler.js) para erros de usuÃ¡rio
- Logs estruturados com nÃ­veis apropriados
- Toast notifications via [public/js/ui.js](mdc:public/js/ui.js)

### ConfiguraÃ§Ã£o Segura
- Todas as configuraÃ§Ãµes via [src/config.js](mdc:src/config.js)
- Arquivo config.enc criptografado obrigatÃ³rio
- Middleware de autenticaÃ§Ã£o em [src/api/middleware/auth.js](mdc:src/api/middleware/auth.js)
- Nunca hardcode credenciais

## ğŸ“ Logging PadrÃ£o

### NÃ­veis de Log (winston)
- **error**: Falhas crÃ­ticas, exceÃ§Ãµes
- **warn**: SituaÃ§Ãµes inesperadas, nÃ£o crÃ­ticas
- **info**: OperaÃ§Ãµes principais, status
- **debug**: InformaÃ§Ãµes detalhadas (desenvolvimento)

### Formato PadrÃ£o
```javascript
logger.info('Iniciando backup de bancos: ' + databases.join(', '));
logger.error('Falha ao conectar FTP', { host: config.ftp.host, error: err.message });
```

## ğŸš€ Build e Deployment

### Build Process ([scripts/build.js](mdc:scripts/build.js))
1. Embarca assets (7za.exe, nssm.exe, public/)
2. Gera embedded-assets.js temporÃ¡rio
3. Executa pkg com target node12-win-x64
4. Limpa arquivos temporÃ¡rios

### Assets Embarcados
- 7za.exe para compressÃ£o
- nssm.exe para serviÃ§o Windows
- Todos os arquivos public/ para interface web modular

### ExecutÃ¡vel Final
- NodeBackup.exe Ãºnico (Â±57MB)
- Autocontido, sem dependÃªncias externas
- CompatÃ­vel Windows 7+

## ğŸ”„ Testes e ValidaÃ§Ã£o

### Compatibilidade ObrigatÃ³ria
- Testar em Node.js 12.x antes de commit
- Validar build com pkg node12-win-x64
- Verificar funcionamento como serviÃ§o Windows
- Testar responsividade em mÃºltiplos dispositivos

### ValidaÃ§Ãµes de CÃ³digo
- NÃ£o usar features Node 14+
- Evitar dependÃªncias que quebrem Node 12
- Manter compatibilidade com sqlcmd legado
- Validar funcionamento de todos os mÃ³dulos JS/CSS

## ğŸ¨ PadrÃµes de Desenvolvimento Frontend

### Nomenclatura de Arquivos
- **CSS**: Usar kebab-case (`base.css`, `components.css`)
- **JavaScript**: Usar camelCase nos nomes de funÃ§Ã£o
- **Modularidade**: Um arquivo por responsabilidade

### Performance e Tamanho
- **CSS Total**: Manter < 25KB (5 arquivos CSS)
- **JavaScript Total**: Manter < 35KB (8 mÃ³dulos JS)
- **Compatibilidade**: IE11+, Chrome 60+, Firefox 55+

### Sistema de Temas
- **VariÃ¡veis CSS**: Definir em [public/css/base.css](mdc:public/css/base.css)
- **Theme Toggle**: Implementado em [public/js/ui.js](mdc:public/js/ui.js)
- **FOUC Prevention**: Script inline no `<head>` de todos os HTMLs

## ğŸ“‹ Checklist para Novas Features

### âœ… Frontend
- [ ] Criar mÃ³dulo JS especÃ­fico se necessÃ¡rio
- [ ] Adicionar estilos no mÃ³dulo CSS apropriado
- [ ] Testar responsividade mobile
- [ ] Verificar funcionamento em tema escuro
- [ ] Implementar loading states apropriados

### âœ… Backend  
- [ ] Criar rota em mÃ³dulo apropriado
- [ ] Aplicar middleware de autenticaÃ§Ã£o
- [ ] Implementar logs estruturados
- [ ] Testar tratamento de erros
- [ ] Validar entrada de dados

### âœ… Build e Deploy
- [ ] Verificar compatibilidade Node 12
- [ ] Testar build local
- [ ] Validar tamanho do executÃ¡vel
- [ ] Testar instalaÃ§Ã£o como serviÃ§o

